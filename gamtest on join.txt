import { Commands, World, Player, Dimension, Entity, ItemStack, MinecraftItemTypes } from 'mojang-minecraft';


// Run when a player loads and joins
// All This was contributed by MrPatches123
const betaPlayerFunctions = {
    runCommand: function (command) {
        const name = this.nameTag ?? this;
        return Commands.run(`${command.replaceAll('@s',`"${name}"`)}`, World.getDimension('overworld'));
    },
    runCommands: function () {
        const commands = (typeof arguments[0] === 'array') ? arguments[0] : [...arguments];
        const name = this.nameTag ?? this;
        let returnArray = [];
        for (const command of commands) {
            return Commands.run(`${command.replaceAll('@s',`"${name}"`)}`, World.getDimension('overworld'));
        } return returnArray
        
    },
    getName: function () {
        //if (/"|\\/.test(this.nameTag)) {
        //    this.nameTag = this.nameTag.replace(/"|\\/g, '');
        //}
         return this.nameTag;
    } //not beta but fixes nameSpoof command tartgeting issues
};
Object.assign(Player.prototype, betaPlayerFunctions);
Object.assign(Entity.prototype, betaPlayerFunctions);
Object.assign(String.prototype, betaPlayerFunctions);

const betaDimensionFunctions = {
    runCommand: function (command) {
        const name = this.nameTag;
        return Commands.run(`${command}`, this);
    },
    runCommands: function () {
        const commands = (typeof arguments[0] === 'array') ? arguments[0] : [...arguments];
        const name = this.nameTag;
        let returnArray = [];
        for (const command of commands) {
            return Commands.run(`${command}`, this);
        } return returnArray
        
    }
}
Object.assign(Dimension.prototype, betaDimensionFunctions);
const world = World
const overworld = World.getDimension('overworld');
let loaded = false;
let playerMap = new Map();

World.events.tick.subscribe(({ currentTick, deltaTime }) => {
    try {
        if (!loaded) {
            try {
                overworld.runCommand('testfor @a');
                overworld.runCommand(`function tools/packages/serverloaded`).statusMessage;
                loaded = true;
            } catch { }
        } else {
            let players = world.getPlayers()
            const playerlist = players.map(player => player.getName());
            const playersLeave = Object.keys(Object.fromEntries(playerMap)).filter(mapPlayer => !playerlist.some(playerCurrent => playerCurrent === mapPlayer));
            if (playersLeave.length) { playersLeave.forEach(player => playerMap.delete(player)); }
            let string = '';
            for (let player of players) {
                const name = player.getName();
                let object = playerMap.get(name) ?? {};
                let { playerLoaded = false } = object;
                if (!playerLoaded) {
                    try {
                        overworld.runCommand(`testfor @p[name="${name}"]`);
                        overworld.runCommand(`execute "${name}" ~~~ function tools/packages/playerjoined`).statusMessage;
                        object.playerLoaded = true;
                        playerMap.set(name, object);
                        continue;
                    } catch { }
                }
                for (const property in player){
                    if (typeof player[property] === 'object') {
                      string += `${property}:\n`
                      for (const prop in player[property]) {
                        string += (player[property][prop].toString().includes('function')) ?  '' : `   ${prop}: ${player[property][prop]}\n`;
                      }
                    } else {
                      string += (player[property].toString().includes('function')) ?  '' : `${property}: ${player[property]}\n`;
                    }
                }
                //Commands.run(`say ${string}`, World.getDimension('overworld'));
            }
        }
    } catch (error) {
        overworld.runCommand(`w @a[tag=wardenTrusted] ${error} - ${error.stack}`);
    }
});